<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.1">
<link rel="alternate" type="application/rss+xml" href="/mobile-ds/blog/rss.xml" title="PyTorch Mobile Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/mobile-ds/blog/atom.xml" title="PyTorch Mobile Blog Atom Feed"><title data-react-helmet="true">Making a Native Android Application that uses PyTorch prebuilt libraries | PyTorch Mobile</title><meta data-react-helmet="true" property="og:url" content="https://brianjo.github.com/mobile-ds/docs/building/android_native_app_with_custom_op"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Making a Native Android Application that uses PyTorch prebuilt libraries | PyTorch Mobile"><meta data-react-helmet="true" name="description" content="Author: Ivan Kobzarev"><meta data-react-helmet="true" property="og:description" content="Author: Ivan Kobzarev"><link data-react-helmet="true" rel="shortcut icon" href="/mobile-ds/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://brianjo.github.com/mobile-ds/docs/building/android_native_app_with_custom_op"><link data-react-helmet="true" rel="alternate" href="https://brianjo.github.com/mobile-ds/docs/building/android_native_app_with_custom_op" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://brianjo.github.com/mobile-ds/docs/building/android_native_app_with_custom_op" hreflang="x-default"><link rel="stylesheet" href="/mobile-ds/assets/css/styles.f84ef0c2.css">
<link rel="preload" href="/mobile-ds/assets/js/runtime~main.13c9f74d.js" as="script">
<link rel="preload" href="/mobile-ds/assets/js/main.fec1926f.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP shadow--md">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/mobile-ds/"><img src="/mobile-ds/img/logo.svg" alt="PyTorch" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/mobile-ds/img/logo.svg" alt="PyTorch" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">PyTorch Mobile</b></a><a class="navbar__item navbar__link navbar__link--active" href="/mobile-ds/docs/intro">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/pytorch/pytorch" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/mobile-ds/"><img src="/mobile-ds/img/logo.svg" alt="PyTorch" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/mobile-ds/img/logo.svg" alt="PyTorch" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">PyTorch Mobile</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/mobile-ds/docs/intro">Documentation</a></li><li class="menu__list-item"><a href="https://github.com/pytorch/pytorch" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu menu--responsive thin-scrollbar menu_Bmed" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/mobile-ds/docs/intro">PyTorch Mobile</a></li><li class="menu__list-item"><a class="menu__link" href="/mobile-ds/docs/helloworld">Hello World!</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Model Preparation</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/modelprep/interpreters">Lite and Full Jit Interpreters</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/modelprep/optimization">Script and Optimize for Mobile</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/modelprep/quantization">Quantization</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Build from Source</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/mobile-ds/docs/building/android_native_app_with_custom_op">Making a Native Android Application that uses PyTorch prebuilt libraries</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-ds/docs/building/androidbuild">Building PyTorch Android from Source</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-ds/docs/building/iosbuild">Build PyTorch iOS Libraries from Source</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Performance</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/performance/mobile_perf">Pytorch Mobile Performance Recipes</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Tutorials</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/tutorials/overview">Overview</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Videos</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/videos/overview">Getting Started</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/mobile-ds/docs/android">Android</a></li><li class="menu__list-item"><a class="menu__link" href="/mobile-ds/docs/ios">iOS</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><header><h1 class="h1Heading_27L5">Making a Native Android Application that uses PyTorch prebuilt libraries</h1></header><p><strong>Author</strong>: <a href="https://github.com/IvanKobzarev" target="_blank" rel="noopener noreferrer">Ivan Kobzarev</a></p><p>In this recipe, you will learn:</p><blockquote><ul><li>How to make an Android Application that uses LibTorch API from
native code (C++).</li><li>How to use within this application TorchScript models with custom
operators.</li></ul></blockquote><p>The full setup of this app you can find in <a href="https://github.com/pytorch/android-demo-app/tree/master/NativeApp" target="_blank" rel="noopener noreferrer">PyTorch Android Demo
Application
Repository</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="setup"></a>Setup<a class="hash-link" href="#setup" title="Direct link to heading">#</a></h2><p>You will need a Python 3 environment with the following packages (and
their dependencies) installed:</p><ul><li>PyTorch 1.6</li></ul><p>For Android development, you will need to install:</p><ul><li>Android NDK</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">wget https://dl.google.com/android/repository/android-ndk-r19c-linux-x86_64.zip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">unzip android-ndk-r19c-linux-x86_64.zip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">export ANDROID_NDK=$(pwd)/android-ndk-r19c</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>Android SDK</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">wget https://dl.google.com/android/repository/sdk-tools-linux-3859397.zip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">unzip sdk-tools-linux-3859397.zip -d android_sdk</span></span><span class="token-line" style="color:#393A34"><span class="token plain">export ANDROID_HOME=$(pwd)/android_sdk</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>Gradle 4.10.3</li></ul><p>Gradle is the most widely used build system for android applications,
and we will need it to build our application. Download it and add to the
path to use <code>gradle</code> in the command line.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">wget https://services.gradle.org/distributions/gradle-4.10.3-bin.zip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">unzip gradle-4.10.3-bin.zip</span></span><span class="token-line" style="color:#393A34"><span class="token plain">export GRADLE_HOME=$(pwd)/gradle-4.10.3</span></span><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=&quot;${GRADLE_HOME}/bin/:${PATH}&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>JDK</li></ul><p>Gradle requires JDK, you need to install it and set environment variable
<code>JAVA_HOME</code> to point to it. For example you can install OpenJDK,
following <a href="https://openjdk.java.net/install/" target="_blank" rel="noopener noreferrer">instructions</a>.</p><ul><li>OpenCV SDK for Android</li></ul><p>Our custom operator will be implemented using the OpenCV library. To use
it for Android, we need to download OpenCV SDK for Android with prebuilt
libraries. Download from <a href="https://opencv.org/releases/" target="_blank" rel="noopener noreferrer">OpenCV releases
page</a>. Unzip it and set the environment
variable <code>OPENCV_ANDROID_SDK</code> to it.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="preparing-torchscript-model-with-custom-c-operator"></a>Preparing TorchScript Model With Custom C++ Operator<a class="hash-link" href="#preparing-torchscript-model-with-custom-c-operator" title="Direct link to heading">#</a></h2><p>TorchScript allows using custom C++ operators, to read about it with
details you can read <a href="https://pytorch.org/tutorials/advanced/torch_script_custom_ops.html" target="_blank" rel="noopener noreferrer">the dedicated
tutorial</a>.</p><p>As a result, you can script the model that uses custom op, that uses
OpenCV <code>cv::warpPerspective</code> function.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">import torch</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import torch.utils.cpp_extension</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">print(torch.version.__version__)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">op_source = &quot;&quot;&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;opencv2/opencv.hpp&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;torch/script.h&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">torch::Tensor warp_perspective(torch::Tensor image, torch::Tensor warp) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  cv::Mat image_mat(/*rows=*/image.size(0),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    /*cols=*/image.size(1),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    /*type=*/CV_32FC1,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    /*data=*/image.data_ptr&lt;float&gt;());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  cv::Mat warp_mat(/*rows=*/warp.size(0),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   /*cols=*/warp.size(1),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   /*type=*/CV_32FC1,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   /*data=*/warp.data_ptr&lt;float&gt;());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  cv::Mat output_mat;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  cv::warpPerspective(image_mat, output_mat, warp_mat, /*dsize=*/{64, 64});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  torch::Tensor output =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    torch::from_blob(output_mat.ptr&lt;float&gt;(), /*sizes=*/{64, 64});</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return output.clone();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">static auto registry =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  torch::RegisterOperators(&quot;my_ops::warp_perspective&quot;, &amp;warp_perspective);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;&quot;&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">torch.utils.cpp_extension.load_inline(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    name=&quot;warp_perspective&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    cpp_sources=op_source,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    extra_ldflags=[&quot;-lopencv_core&quot;, &quot;-lopencv_imgproc&quot;],</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    is_python_module=False,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    verbose=True,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">print(torch.ops.my_ops.warp_perspective)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@torch.jit.script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">def compute(x, y):</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if bool(x[0][0] == 42):</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        z = 5</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    else:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        z = 10</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    x = torch.ops.my_ops.warp_perspective(x, torch.eye(3))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return x.matmul(y) + z</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">compute.save(&quot;compute.pt&quot;)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This snippet generates <code>compute.pt</code> file which is TorchScript model that
uses custom op <code>my_ops.warp_perspective</code>.</p><p>You need to have installed OpenCV for development to run it. For Linux
systems that can be done using the next commands: CentOS:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">yum install opencv-devel</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Ubuntu:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">apt-get install libopencv-dev</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="making-android-application"></a>Making Android Application<a class="hash-link" href="#making-android-application" title="Direct link to heading">#</a></h2><p>After we succeeded in having <code>compute.pt</code>, we want to use this
TorchScript model within Android application. Using general TorchScript
models (without custom operators) on Android, using Java API, you can
find <a href="https://pytorch.org/mobile/android/" target="_blank" rel="noopener noreferrer">here</a>. We can not use this
approach for our case, as our model uses a custom
operator(<code>my_ops.warp_perspective</code>), default TorchScript execution will
fail to find it.</p><p>Registration of ops is not exposed to PyTorch Java API, thus we need to
build Android Application with native part (C++) and using LibTorch C++
API to implement and register the same custom operator for Android. As
our operator uses the OpenCV library - we will use prebuilt OpenCV
Android libraries and use the same functions from OpenCV.</p><p>Let&#x27;s start creating Android application in <code>NativeApp</code> folder.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir NativeApp</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cd NativeApp</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="android-application-build-setup"></a>Android Application Build Setup<a class="hash-link" href="#android-application-build-setup" title="Direct link to heading">#</a></h2><p>Android Application build consists of the main gradle part and native
build CMake part. All the listings here are the full file listing, that
if to recreate the whole structure, you will be able to build and
install the result Android Application without any code additions.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="gradle-build-setup"></a>Gradle Build Setup<a class="hash-link" href="#gradle-build-setup" title="Direct link to heading">#</a></h3><p>We will need to add gradle setup files: build.gradle, gradle.properties,
settings.gradle. More about Android Gradle build configurations you can
find <a href="https://developer.android.com/studio/build" target="_blank" rel="noopener noreferrer">here</a>.</p><p><code>NativeApp/settings.gradle</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">include &#x27;:app&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>NativeApp/gradle.properties</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">android.useAndroidX=true</span></span><span class="token-line" style="color:#393A34"><span class="token plain">android.enableJetifier=true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>NativeApp/build.gradle</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">buildscript {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    repositories {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        google()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        jcenter()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    dependencies {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        classpath &#x27;com.android.tools.build:gradle:3.5.0&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">allprojects {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    repositories {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        google()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        jcenter()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In <code>NativeApp/build.gradle</code> we specify Android gradle plugin version</p><span class="title-ref">3.5.0</span>. This version is not recent. Still, we use it as PyTorch android gradle builds use this version.<p><code>NativeApp/settings.gradle</code> shows that out project contains only one
module - <code>app</code>, which will be our Android Application.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir app</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cd app</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>NativeApp/app/build.gradle</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">apply plugin: &#x27;com.android.application&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">repositories {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  jcenter()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  maven {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    url &quot;https://oss.sonatype.org/content/repositories/snapshots&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">android {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  configurations {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    extractForNativeBuild</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  compileSdkVersion 28</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  buildToolsVersion &quot;29.0.2&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  defaultConfig {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    applicationId &quot;org.pytorch.nativeapp&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    minSdkVersion 21</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    targetSdkVersion 28</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    versionCode 1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    versionName &quot;1.0&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    externalNativeBuild {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      cmake {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        arguments &quot;-DANDROID_STL=c++_shared&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  buildTypes {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    release {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      minifyEnabled false</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  externalNativeBuild {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    cmake {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      path &quot;CMakeLists.txt&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sourceSets {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    main {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      jniLibs.srcDirs = [&#x27;src/main/jniLibs&#x27;]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dependencies {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  implementation &#x27;com.android.support:appcompat-v7:28.0.0&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  implementation &#x27;org.pytorch:pytorch_android:1.6.0-SNAPSHOT&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  extractForNativeBuild &#x27;org.pytorch:pytorch_android:1.6.0-SNAPSHOT&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">task extractAARForNativeBuild {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  doLast {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    configurations.extractForNativeBuild.files.each {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      def file = it.absoluteFile</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      copy {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        from zipTree(file)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        into &quot;$buildDir/$file.name&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        include &quot;headers/**&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        include &quot;jni/**&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">tasks.whenTaskAdded { task -&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (task.name.contains(&#x27;externalNativeBuild&#x27;)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    task.dependsOn(extractAARForNativeBuild)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This gradle build script registers dependencies on pytorch_android
snapshots, that are published on nightly channels.</p><p>As they are published to nexus sonatype repository - we need to register
that repository:
<code>https://oss.sonatype.org/content/repositories/snapshots</code>.</p><p>In our application we need to use LibTorch C++ API in our application
native build part. For this, we need access to prebuilt binaries and
headers. They are prepacked in PyTorch Android builds, which is
published in Maven repositories.</p><p>To use PyTorch Android prebuilt libraries from gradle dependencies
(which is aar files) - we should add registration for configuration
<code>extractForNativeBuild</code>, add this configuration in dependencies and put
its definition in the end.</p><p><code>extractForNativeBuild</code> task will call <code>extractAARForNativeBuild</code> task
that unpacks pytorch_android aar to gradle build directory.</p><p>Pytorch_android aar contains LibTorch headers in <code>headers</code> folder and
prebuilt libraries for different Android abis in <code>jni</code> folder:
<code>$ANDROID_ABI/libpytorch_jni.so</code>, <code>$ANDROID_ABI/libfbjni.so</code>. We will
use them for our native build.</p><p>The native build is registered in this <code>build.gradle</code> with lines:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">android {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  externalNativeBuild {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    cmake {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      path &quot;CMakeLists.txt&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">defaultConfig {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  externalNativeBuild {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    cmake {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      arguments &quot;-DANDROID_STL=c++_shared&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We will use <code>CMake</code> configuration for a native build. Here we also
specify that we will dynamically link with STL, as we have several
libraries. More about this, you can find
<a href="https://developer.android.com/ndk/guides/cpp-support" target="_blank" rel="noopener noreferrer">here</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="native-build-cmake-setup"></a>Native Build CMake Setup<a class="hash-link" href="#native-build-cmake-setup" title="Direct link to heading">#</a></h3><p>The native build will be configured in <code>NativeApp/app/CMakeLists.txt</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">cmake_minimum_required(VERSION 3.4.1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">set(TARGET pytorch_nativeapp)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">project(${TARGET} CXX)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">set(CMAKE_CXX_STANDARD 14)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">set(build_DIR ${CMAKE_SOURCE_DIR}/build)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">set(pytorch_testapp_cpp_DIR ${CMAKE_CURRENT_LIST_DIR}/src/main/cpp)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">file(GLOB pytorch_testapp_SOURCES</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ${pytorch_testapp_cpp_DIR}/pytorch_nativeapp.cpp</span></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">add_library(${TARGET} SHARED</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ${pytorch_testapp_SOURCES}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">file(GLOB PYTORCH_INCLUDE_DIRS &quot;${build_DIR}/pytorch_android*.aar/headers&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">file(GLOB PYTORCH_LINK_DIRS &quot;${build_DIR}/pytorch_android*.aar/jni/${ANDROID_ABI}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">target_compile_options(${TARGET} PRIVATE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  -fexceptions</span></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">set(BUILD_SUBDIR ${ANDROID_ABI})</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">find_library(PYTORCH_LIBRARY pytorch_jni</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  PATHS ${PYTORCH_LINK_DIRS}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  NO_CMAKE_FIND_ROOT_PATH)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">find_library(FBJNI_LIBRARY fbjni</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  PATHS ${PYTORCH_LINK_DIRS}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  NO_CMAKE_FIND_ROOT_PATH)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># OpenCV</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if(NOT DEFINED ENV{OPENCV_ANDROID_SDK})</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  message(FATAL_ERROR &quot;Environment var OPENCV_ANDROID_SDK is not set&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">endif()</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">set(OPENCV_INCLUDE_DIR &quot;$ENV{OPENCV_ANDROID_SDK}/sdk/native/jni/include&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">target_include_directories(${TARGET} PRIVATE</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;${OPENCV_INCLUDE_DIR}&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ${PYTORCH_INCLUDE_DIRS})</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">set(OPENCV_LIB_DIR &quot;$ENV{OPENCV_ANDROID_SDK}/sdk/native/libs/${ANDROID_ABI}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">find_library(OPENCV_LIBRARY opencv_java4</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  PATHS ${OPENCV_LIB_DIR}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  NO_CMAKE_FIND_ROOT_PATH)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">target_link_libraries(${TARGET}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ${PYTORCH_LIBRARY}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ${FBJNI_LIBRARY}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ${OPENCV_LIBRARY}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  log)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here we register only one source file <code>pytorch_nativeapp.cpp</code>.</p><p>On the previous step in <code>NativeApp/app/build.gradle</code>, the task
<code>extractAARForNativeBuild</code> extracts headers and native libraries to
build directory. We set <code>PYTORCH_INCLUDE_DIRS</code> and <code>PYTORCH_LINK_DIRS</code>
to them.</p><p>After that, we find libraries <code>libpytorch_jni.so</code> and <code>libfbjni.so</code> and
add them to the linking of our target.</p><p>As we plan to use OpenCV functions to implement our custom operator
<code>my_ops::warp_perspective</code> - we need to link to <code>libopencv_java4.so</code>. It
is packaged in OpenCV SDK for Android, that was downloaded on the Setup
step. In this configuration, we find it by environment variable
<code>OPENCV_ANDROID_SDK</code>.</p><p>We also link with <code>log</code> library to be able to log our results to Android
LogCat.</p><p>As we link to OpenCV Android SDK&#x27;s <code>libopencv_java4.so</code>, we should copy
it to <code>NativeApp/app/src/main/jniLibs/${ANDROID_ABI}</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">cp -R $OPENCV_ANDROID_SDK/sdk/native/libs/* NativeApp/app/src/main/jniLibs/</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="adding-the-model-file-to-the-application"></a>Adding the model file to the application<a class="hash-link" href="#adding-the-model-file-to-the-application" title="Direct link to heading">#</a></h3><p>To package the TorschScript model <code>compute.pt</code> within our application we
should copy it to assets folder:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p NativeApp/app/src/main/assets</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cp compute.pt NativeApp/app/src/main/assets</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="android-application-manifest"></a>Android Application Manifest<a class="hash-link" href="#android-application-manifest" title="Direct link to heading">#</a></h3><p>Every Android application has a manifest. Here we specify the
application name, package, main activity.</p><p><code>NativeApp/app/src/main/AndroidManifest.xml</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    package=&quot;org.pytorch.nativeapp&quot;&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;application</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        android:allowBackup=&quot;true&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        android:label=&quot;PyTorchNativeApp&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        android:supportsRtl=&quot;true&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        android:theme=&quot;@style/Theme.AppCompat.Light.DarkActionBar&quot;&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;activity android:name=&quot;.MainActivity&quot;&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;intent-filter&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/intent-filter&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/activity&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/application&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/manifest&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sources"></a>Sources<a class="hash-link" href="#sources" title="Direct link to heading">#</a></h3><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="java-code"></a>Java Code<a class="hash-link" href="#java-code" title="Direct link to heading">#</a></h3><p>Now we are ready to implement our MainActivity in</p><p><code>NativeApp/app/src/main/java/org/pytorch/nativeapp/MainActivity.java</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package org.pytorch.nativeapp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import android.content.Context;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import android.os.Bundle;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import android.util.Log;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import androidx.appcompat.app.AppCompatActivity;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.File;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.FileOutputStream;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.InputStream;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.OutputStream;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MainActivity extends AppCompatActivity {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static final String TAG = &quot;PyTorchNativeApp&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static String assetFilePath(Context context, String assetName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    File file = new File(context.getFilesDir(), assetName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (file.exists() &amp;&amp; file.length() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return file.getAbsolutePath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try (InputStream is = context.getAssets().open(assetName)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      try (OutputStream os = new FileOutputStream(file)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        byte[] buffer = new byte[4 * 1024];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int read;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        while ((read = is.read(buffer)) != -1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          os.write(buffer, 0, read);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        os.flush();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      return file.getAbsolutePath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Log.e(TAG, &quot;Error process asset &quot; + assetName + &quot; to file path&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  protected void onCreate(Bundle savedInstanceState) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.onCreate(savedInstanceState);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String modelFileAbsoluteFilePath =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        new File(assetFilePath(this, &quot;compute.pt&quot;)).getAbsolutePath();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    NativeClient.loadAndForwardModel(modelFileAbsoluteFilePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In the previous step, when we copied our <code>compute.pt</code> to
<code>NativeApp/app/src/main/assets</code> that file became an Android application
asset, which will be packed in application. Android system provides only
stream access to it. To use this module from LibTorch, we need to
materialize it as a file on the disk. <code>assetFilePath</code> function copies
data from the asset input stream, writes it on the disk, and returns
absolute file path for it.</p><p><code>OnCreate</code> method of Activity is called just after Activity creation. In
this method, we call <code>assertFilePath</code> and call <code>NativeClient</code> class that
will dispatch it to native code through JNI call.</p><p><code>NativeClient</code> is a helper class with an internal private class
<code>NativePeer</code>, which is responsible for working with the native part of
our application. It has a static block that will load
<code>libpytorch_nativeapp.so</code>, that is build with <code>CMakeLists.txt</code> that we
added on the previous step. The static block will be executed with the
first reference of <code>NativePeer</code> class. It happens in
<code>NativeClient#loadAndForwardModel</code>.</p><p><code>NativeApp/app/src/main/java/org/pytorch/nativeapp/NativeClient.java</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package org.pytorch.nativeapp;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class NativeClient {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static void loadAndForwardModel(final String modelPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    NativePeer.loadAndForwardModel(modelPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static class NativePeer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      System.loadLibrary(&quot;pytorch_nativeapp&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static native void loadAndForwardModel(final String modelPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>NativePeer#loadAndForwardModel</code> is declared as <code>native</code>, it does not
have definition in Java. Call to this method will be re-dispatched
through JNI to C++ method in our <code>libpytorch_nativeapp.so</code>, in
<code>NativeApp/app/src/main/cpp/pytorch_nativeapp.cpp</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="native-code"></a>Native code<a class="hash-link" href="#native-code" title="Direct link to heading">#</a></h3><p>Now we are ready to write a native part of our application.</p><p><code>NativeApp/app/src/main/cpp/pytorch_nativeapp.cpp</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;android/log.h&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;cassert&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;cmath&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;pthread.h&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;unistd.h&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;vector&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#define ALOGI(...)                                                             \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  __android_log_print(ANDROID_LOG_INFO, &quot;PyTorchNativeApp&quot;, __VA_ARGS__)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#define ALOGE(...)                                                             \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  __android_log_print(ANDROID_LOG_ERROR, &quot;PyTorchNativeApp&quot;, __VA_ARGS__)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &quot;jni.h&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;opencv2/opencv.hpp&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;torch/script.h&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace pytorch_nativeapp {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">torch::Tensor warp_perspective(torch::Tensor image, torch::Tensor warp) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  cv::Mat image_mat(/*rows=*/image.size(0),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    /*cols=*/image.size(1),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    /*type=*/CV_32FC1,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    /*data=*/image.data_ptr&lt;float&gt;());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  cv::Mat warp_mat(/*rows=*/warp.size(0),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   /*cols=*/warp.size(1),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   /*type=*/CV_32FC1,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                   /*data=*/warp.data_ptr&lt;float&gt;());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  cv::Mat output_mat;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  cv::warpPerspective(image_mat, output_mat, warp_mat, /*dsize=*/{8, 8});</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  torch::Tensor output =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      torch::from_blob(output_mat.ptr&lt;float&gt;(), /*sizes=*/{8, 8});</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return output.clone();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">static auto registry =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    torch::RegisterOperators(&quot;my_ops::warp_perspective&quot;, &amp;warp_perspective);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">template &lt;typename T&gt; void log(const char *m, T t) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  std::ostringstream os;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  os &lt;&lt; t &lt;&lt; std::endl;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ALOGI(&quot;%s %s&quot;, m, os.str().c_str());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">struct JITCallGuard {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  torch::autograd::AutoGradMode no_autograd_guard{false};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  torch::AutoNonVariableTypeMode non_var_guard{true};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  torch::jit::GraphOptimizerEnabledGuard no_optimizer_guard{false};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">} // namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">static void loadAndForwardModel(JNIEnv *env, jclass, jstring jModelPath) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  const char *modelPath = env-&gt;GetStringUTFChars(jModelPath, 0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  assert(modelPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  JITCallGuard guard;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  torch::jit::Module module = torch::jit::load(modelPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  module.eval();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  torch::Tensor x = torch::randn({4, 8});</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  torch::Tensor y = torch::randn({8, 5});</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  log(&quot;x:&quot;, x);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  log(&quot;y:&quot;, y);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  c10::IValue t_out = module.forward({x, y});</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  log(&quot;result:&quot;, t_out);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  env-&gt;ReleaseStringUTFChars(jModelPath, modelPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">} // namespace pytorch_nativeapp</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">JNIEXPORT jint JNI_OnLoad(JavaVM *vm, void *) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  JNIEnv *env;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (vm-&gt;GetEnv(reinterpret_cast&lt;void **&gt;(&amp;env), JNI_VERSION_1_6) != JNI_OK) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return JNI_ERR;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  jclass c = env-&gt;FindClass(&quot;org/pytorch/nativeapp/NativeClient$NativePeer&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (c == nullptr) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return JNI_ERR;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  static const JNINativeMethod methods[] = {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      {&quot;loadAndForwardModel&quot;, &quot;(Ljava/lang/String;)V&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       (void *)pytorch_nativeapp::loadAndForwardModel},</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  int rc = env-&gt;RegisterNatives(c, methods,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                sizeof(methods) / sizeof(JNINativeMethod));</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (rc != JNI_OK) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return rc;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return JNI_VERSION_1_6;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This listing is quite long, and a few things intermixed here, we will
follow control flow to understand how this code works. The first place
where the control flow arrives is <code>JNI_OnLoad</code>. This function is called
after loading the library. It is responsible for registering native
method, which is called when <code>NativePeer#loadAndForwardModel</code> called,
here it is <code>pytorch_nativeapp::loadAndForwardModel</code> function.</p><p><code>pytorch_nativeapp::loadAndForwardModel</code> takes as an argument model
path. First, we extract its <code>const char*</code> value and loading the module
with <code>torch::jit::load</code>.</p><p>To load TorchScript model for mobile, we need to set these guards,
because mobile build doesn&#x27;t support features like autograd for smaller
build size, placed in <code>struct JITCallGuard</code> in this example. It may
change in the future. You can track the latest changes keeping an eye on
the <a href="https://github.com/pytorch/pytorch/blob/master/android/pytorch_android/src/main/cpp/pytorch_jni_jit.cpp" target="_blank" rel="noopener noreferrer">source in PyTorch
GitHub</a>.</p><p>Implementation of method <code>warp_perspective</code> and registration of it is
entirely the same as in <a href="https://pytorch.org/tutorials/advanced/torch_script_custom_ops.html" target="_blank" rel="noopener noreferrer">tutorial for desktop
build</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="building-the-app"></a>Building the app<a class="hash-link" href="#building-the-app" title="Direct link to heading">#</a></h3><p>To specify to gradle where is Android SDK and Android NDK, we need to
fill <code>NativeApp/local.properties</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">cd NativeApp</span></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;sdk.dir=$ANDROID_HOME&quot; &gt;&gt; NativeApp/local.properties</span></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;ndk.dir=$ANDROID_NDK&quot; &gt;&gt; NativeApp/local.properties</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To build the result <code>apk</code> file we run:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">cd NativeApp</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gradle app:assembleDebug</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To install the app on the connected device:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">cd NativeApp</span></span><span class="token-line" style="color:#393A34"><span class="token plain">gradle app::installDebug</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After that, you can run the app on the device by clicking on
PyTorchNativeApp icon. Or you can do it from the command line:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">adb shell am start -n org.pytorch.nativeapp/.MainActivity</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If you check the android logcat:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">adb logcat -v brief | grep PyTorchNativeApp</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You should see logs with tag &#x27;PyTorchNativeApp&#x27; that prints x, y, and
the result of the model forward, which we print with <code>log</code> function in
<code>NativeApp/app/src/main/cpp/pytorch_nativeapp.cpp</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): x: -0.9484 -1.1757 -0.5832  0.9144  0.8867  1.0933 -0.4004 -0.3389</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): -1.0343  1.5200 -0.7625 -1.5724 -1.2073  0.4613  0.2730 -0.6789</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): -0.2247 -1.2790  1.0067 -0.9266  0.6034 -0.1941  0.7021 -1.5368</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): -0.3803 -0.0188  0.2021 -0.7412 -0.2257  0.5044  0.6592  0.0826</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): [ CPUFloatType{4,8} ]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): y: -1.0084  1.8733  0.5435  0.1087 -1.1066</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): -1.9926  1.1047  0.5311 -0.4944  1.9178</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): -1.5451  0.8867  1.0473 -1.7571  0.3909</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968):  0.4039  0.5085 -0.2776  0.4080  0.9203</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968):  0.3655  1.4395 -1.4467 -0.9837  0.3335</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): -0.0445  0.8039 -0.2512 -1.3122  0.6543</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): -1.5819  0.0525  1.5680 -0.6442 -1.3090</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): -1.6197 -0.0773 -0.5967 -0.1105 -0.3122</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): [ CPUFloatType{8,5} ]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): result:  16.0274   9.0330   6.0124   9.8644  11.0493</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968):   8.7633   6.9657  12.3469  10.3159  12.0683</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968):  12.4529   9.4559  11.7038   7.8396   6.9716</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968):   8.5279   9.1780  11.3849   8.4368   9.1480</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968):  10.0000  10.0000  10.0000  10.0000  10.0000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968):  10.0000  10.0000  10.0000  10.0000  10.0000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968):  10.0000  10.0000  10.0000  10.0000  10.0000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968):  10.0000  10.0000  10.0000  10.0000  10.0000</span></span><span class="token-line" style="color:#393A34"><span class="token plain">I/PyTorchNativeApp(26968): [ CPUFloatType{8,5} ]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The full setup of this app you can find in <a href="https://github.com/pytorch/android-demo-app/tree/master/NativeApp" target="_blank" rel="noopener noreferrer">PyTorch Android Demo
Application
Repository</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/building/android_native_app_with_custom_op.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/mobile-ds/docs/modelprep/quantization"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label"> Quantization</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/mobile-ds/docs/building/androidbuild"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Building PyTorch Android from Source </div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#setup" class="table-of-contents__link">Setup</a></li><li><a href="#preparing-torchscript-model-with-custom-c-operator" class="table-of-contents__link">Preparing TorchScript Model With Custom C++ Operator</a></li><li><a href="#making-android-application" class="table-of-contents__link">Making Android Application</a></li><li><a href="#android-application-build-setup" class="table-of-contents__link">Android Application Build Setup</a><ul><li><a href="#gradle-build-setup" class="table-of-contents__link">Gradle Build Setup</a></li><li><a href="#native-build-cmake-setup" class="table-of-contents__link">Native Build CMake Setup</a></li><li><a href="#adding-the-model-file-to-the-application" class="table-of-contents__link">Adding the model file to the application</a></li><li><a href="#android-application-manifest" class="table-of-contents__link">Android Application Manifest</a></li><li><a href="#sources" class="table-of-contents__link">Sources</a></li><li><a href="#java-code" class="table-of-contents__link">Java Code</a></li><li><a href="#native-code" class="table-of-contents__link">Native code</a></li><li><a href="#building-the-app" class="table-of-contents__link">Building the app</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mobile-ds/docs/intro">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/pytorch/pytorch" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright  2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/mobile-ds/assets/js/runtime~main.13c9f74d.js"></script>
<script src="/mobile-ds/assets/js/main.fec1926f.js"></script>
</body>
</html>
<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.1">
<link rel="alternate" type="application/rss+xml" href="/mobile-ds/blog/rss.xml" title="PyTorch Mobile Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/mobile-ds/blog/atom.xml" title="PyTorch Mobile Blog Atom Feed"><title data-react-helmet="true">Android | PyTorch Mobile</title><meta data-react-helmet="true" property="og:url" content="https://brianjo.github.com/mobile-ds/docs/android"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Android | PyTorch Mobile"><meta data-react-helmet="true" name="description" content="(This file will be deleted)"><meta data-react-helmet="true" property="og:description" content="(This file will be deleted)"><link data-react-helmet="true" rel="shortcut icon" href="/mobile-ds/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://brianjo.github.com/mobile-ds/docs/android"><link data-react-helmet="true" rel="alternate" href="https://brianjo.github.com/mobile-ds/docs/android" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://brianjo.github.com/mobile-ds/docs/android" hreflang="x-default"><link rel="stylesheet" href="/mobile-ds/assets/css/styles.f84ef0c2.css">
<link rel="preload" href="/mobile-ds/assets/js/runtime~main.13c9f74d.js" as="script">
<link rel="preload" href="/mobile-ds/assets/js/main.fec1926f.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP shadow--md">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/mobile-ds/"><img src="/mobile-ds/img/logo.svg" alt="PyTorch" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/mobile-ds/img/logo.svg" alt="PyTorch" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">PyTorch Mobile</b></a><a class="navbar__item navbar__link navbar__link--active" href="/mobile-ds/docs/intro">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/pytorch/pytorch" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/mobile-ds/"><img src="/mobile-ds/img/logo.svg" alt="PyTorch" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/mobile-ds/img/logo.svg" alt="PyTorch" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">PyTorch Mobile</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/mobile-ds/docs/intro">Documentation</a></li><li class="menu__list-item"><a href="https://github.com/pytorch/pytorch" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu menu--responsive thin-scrollbar menu_Bmed" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/mobile-ds/docs/intro">PyTorch Mobile</a></li><li class="menu__list-item"><a class="menu__link" href="/mobile-ds/docs/helloworld">Hello World!</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Model Preparation</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/modelprep/interpreters">Lite and Full Jit Interpreters</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/modelprep/optimization">Script and Optimize for Mobile</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/modelprep/quantization">Quantization</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Build from Source</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/building/android_native_app_with_custom_op">Making a Native Android Application that uses PyTorch prebuilt libraries</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/building/androidbuild">Building PyTorch Android from Source</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/building/iosbuild">Build PyTorch iOS Libraries from Source</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Performance</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/performance/mobile_perf">Pytorch Mobile Performance Recipes</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Tutorials</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/tutorials/overview">Overview</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Videos</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/videos/overview">Getting Started</a></li></ul></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" href="/mobile-ds/docs/android">Android</a></li><li class="menu__list-item"><a class="menu__link" href="/mobile-ds/docs/ios">iOS</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><header><h1 class="h1Heading_27L5">Android</h1></header><p>(This file will be deleted)</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="quickstart-with-a-helloworld-example"></a>Quickstart with a HelloWorld Example<a class="hash-link" href="#quickstart-with-a-helloworld-example" title="Direct link to heading">#</a></h2><p><a href="https://github.com/pytorch/android-demo-app/tree/master/HelloWorldApp" target="_blank" rel="noopener noreferrer">HelloWorld</a> is a simple image classification application that demonstrates how to use PyTorch Android API.
This application runs TorchScript serialized TorchVision pretrained resnet18 model on static image which is packaged inside the app as android asset.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-model-preparation"></a>1. Model Preparation<a class="hash-link" href="#1-model-preparation" title="Direct link to heading">#</a></h4><p>Let’s start with model preparation. If you are familiar with PyTorch, you probably should already know how to train and save your model. In case you don’t, we are going to use a pre-trained image classification model (<a href="https://pytorch.org/hub/pytorch_vision_mobilenet_v2/" target="_blank" rel="noopener noreferrer">MobileNetV2</a>).
To install it, run the command below:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">pip install torchvision</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To serialize the model you can use python <a href="https://github.com/pytorch/android-demo-app/blob/master/HelloWorldApp/trace_model.py" target="_blank" rel="noopener noreferrer">script</a> in the root folder of HelloWorld app:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">import torch</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import torchvision</span></span><span class="token-line" style="color:#393A34"><span class="token plain">from torch.utils.mobile_optimizer import optimize_for_mobile</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">model = torchvision.models.mobilenet_v2(pretrained=True)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">model.eval()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">example = torch.rand(1, 3, 224, 224)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">traced_script_module = torch.jit.trace(model, example)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">traced_script_module_optimized = optimize_for_mobile(traced_script_module)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">traced_script_module_optimized._save_for_lite_interpreter(&quot;app/src/main/assets/model.ptl&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If everything works well, we should have our model - <code>model.ptl</code> generated in the assets folder of android application.
That will be packaged inside android application as <code>asset</code> and can be used on the device.</p><p>More details about TorchScript you can find in <a href="https://pytorch.org/docs/stable/jit.html" target="_blank" rel="noopener noreferrer">tutorials on pytorch.org</a></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-cloning-from-github"></a>2. Cloning from github<a class="hash-link" href="#2-cloning-from-github" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/pytorch/android-demo-app.git</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cd HelloWorldApp</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If <a href="https://developer.android.com/studio/index.html#command-tools" target="_blank" rel="noopener noreferrer">Android SDK</a> and <a href="https://developer.android.com/ndk/downloads" target="_blank" rel="noopener noreferrer">Android NDK</a> are already installed you can install this application to the connected android device or emulator with:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">./gradlew installDebug</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We recommend you to open this project in <a href="https://developer.android.com/studio" target="_blank" rel="noopener noreferrer">Android Studio 3.5.1+</a>. At the moment PyTorch Android and demo applications use <a href="https://developer.android.com/studio/releases/gradle-plugin#3-5-0" target="_blank" rel="noopener noreferrer">android gradle plugin of version 3.5.0</a>, which is supported only by Android Studio version 3.5.1 and higher.
Using Android Studio you will be able to install Android NDK and Android SDK with Android Studio UI.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-gradle-dependencies"></a>3. Gradle dependencies<a class="hash-link" href="#3-gradle-dependencies" title="Direct link to heading">#</a></h4><p>Pytorch android is added to the HelloWorld as <a href="https://github.com/pytorch/android-demo-app/blob/master/HelloWorldApp/app/build.gradle#L28-L29" target="_blank" rel="noopener noreferrer">gradle dependencies</a> in build.gradle:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">repositories {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    jcenter()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dependencies {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation &#x27;org.pytorch:pytorch_android_lite:1.9.0&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation &#x27;org.pytorch:pytorch_android_torchvision:1.9.0&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Where <code>org.pytorch:pytorch_android</code> is the main dependency with PyTorch Android API, including libtorch native library for all 4 android abis (armeabi-v7a, arm64-v8a, x86, x86_64).
Further in this doc you can find how to rebuild it only for specific list of android abis.</p><p><code>org.pytorch:pytorch_android_torchvision</code> - additional library with utility functions for converting <code>android.media.Image</code> and <code>android.graphics.Bitmap</code> to tensors.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="4-reading-image-from-android-asset"></a>4. Reading image from Android Asset<a class="hash-link" href="#4-reading-image-from-android-asset" title="Direct link to heading">#</a></h4><p>All the logic happens in <a href="https://github.com/pytorch/android-demo-app/blob/master/HelloWorldApp/app/src/main/java/org/pytorch/helloworld/MainActivity.java#L31-L69" target="_blank" rel="noopener noreferrer"><code>org.pytorch.helloworld.MainActivity</code></a>.
As a first step we read <code>image.jpg</code> to <code>android.graphics.Bitmap</code> using the standard Android API.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Bitmap bitmap = BitmapFactory.decodeStream(getAssets().open(&quot;image.jpg&quot;));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="5-loading-mobile-module"></a>5. Loading Mobile Module<a class="hash-link" href="#5-loading-mobile-module" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Module module = Module.load(assetFilePath(this, &quot;model.ptl&quot;));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>org.pytorch.Module</code> represents <code>torch::jit::mobile::Module</code> that can be loaded with <code>load</code> method specifying file path to the serialized to file model.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="6-preparing-input"></a>6. Preparing Input<a class="hash-link" href="#6-preparing-input" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Tensor inputTensor = TensorImageUtils.bitmapToFloat32Tensor(bitmap,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    TensorImageUtils.TORCHVISION_NORM_MEAN_RGB, TensorImageUtils.TORCHVISION_NORM_STD_RGB);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>org.pytorch.torchvision.TensorImageUtils</code> is part of <code>org.pytorch:pytorch_android_torchvision</code> library.
The <code>TensorImageUtils#bitmapToFloat32Tensor</code> method creates tensors in the <a href="https://pytorch.org/docs/stable/torchvision/models.html" target="_blank" rel="noopener noreferrer">torchvision format</a> using <code>android.graphics.Bitmap</code> as a source.</p><blockquote><p>All pre-trained models expect input images normalized in the same way, i.e. mini-batches of 3-channel RGB images of shape (3 x H x W), where H and W are expected to be at least 224.
The images have to be loaded in to a range of <code>[0, 1]</code> and then normalized using <code>mean = [0.485, 0.456, 0.406]</code> and <code>std = [0.229, 0.224, 0.225]</code></p></blockquote><p><code>inputTensor</code>&#x27;s shape is <code>1x3xHxW</code>, where <code>H</code> and <code>W</code> are bitmap height and width appropriately.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="7-run-inference"></a>7. Run Inference<a class="hash-link" href="#7-run-inference" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Tensor outputTensor = module.forward(IValue.from(inputTensor)).toTensor();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">float[] scores = outputTensor.getDataAsFloatArray();</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>org.pytorch.Module.forward</code> method runs loaded module&#x27;s <code>forward</code> method and gets result as <code>org.pytorch.Tensor</code> outputTensor with shape <code>1x1000</code>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="8-processing-results"></a>8. Processing results<a class="hash-link" href="#8-processing-results" title="Direct link to heading">#</a></h4><p>Its content is retrieved using <code>org.pytorch.Tensor.getDataAsFloatArray()</code> method that returns java array of floats with scores for every image net class.</p><p>After that we just find index with maximum score and retrieve predicted class name from <code>ImageNetClasses.IMAGENET_CLASSES</code> array that contains all ImageNet classes.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">float maxScore = -Float.MAX_VALUE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">int maxScoreIdx = -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">for (int i = 0; i &lt; scores.length; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (scores[i] &gt; maxScore) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxScore = scores[i];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    maxScoreIdx = i;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">String className = ImageNetClasses.IMAGENET_CLASSES[maxScoreIdx];</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In the following sections you can find detailed explanations of PyTorch Android API, code walk through for a bigger <a href="https://github.com/pytorch/android-demo-app/tree/master/PyTorchDemoApp" target="_blank" rel="noopener noreferrer">demo application</a>,
implementation details of the API, how to customize and build it from source.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pytorch-demo-application"></a>PyTorch Demo Application<a class="hash-link" href="#pytorch-demo-application" title="Direct link to heading">#</a></h2><p>We have also created another more complex PyTorch Android demo application that does image classification from camera output and text classification in the <a href="https://github.com/pytorch/android-demo-app/tree/master/PyTorchDemoApp" target="_blank" rel="noopener noreferrer">same github repo</a>.</p><p>To get device camera output it uses <a href="https://developer.android.com/training/camerax" target="_blank" rel="noopener noreferrer">Android CameraX API</a>.
All the logic that works with CameraX is separated to <a href="https://github.com/pytorch/android-demo-app/blob/master/PyTorchDemoApp/app/src/main/java/org/pytorch/demo/vision/AbstractCameraXActivity.java" target="_blank" rel="noopener noreferrer"><code>org.pytorch.demo.vision.AbstractCameraXActivity</code></a> class.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">void setupCameraX() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final PreviewConfig previewConfig = new PreviewConfig.Builder().build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Preview preview = new Preview(previewConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    preview.setOnPreviewOutputUpdateListener(output -&gt; mTextureView.setSurfaceTexture(output.getSurfaceTexture()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final ImageAnalysisConfig imageAnalysisConfig =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        new ImageAnalysisConfig.Builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .setTargetResolution(new Size(224, 224))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .setCallbackHandler(mBackgroundHandler)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .setImageReaderMode(ImageAnalysis.ImageReaderMode.ACQUIRE_LATEST_IMAGE)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final ImageAnalysis imageAnalysis = new ImageAnalysis(imageAnalysisConfig);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    imageAnalysis.setAnalyzer(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        (image, rotationDegrees) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          analyzeImage(image, rotationDegrees);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    CameraX.bindToLifecycle(this, preview, imageAnalysis);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  void analyzeImage(android.media.Image, int rotationDegrees)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Where the <code>analyzeImage</code> method process the camera output, <code>android.media.Image</code>.</p><p>It uses the aforementioned <a href="https://github.com/pytorch/pytorch/blob/master/android/pytorch_android_torchvision/src/main/java/org/pytorch/torchvision/TensorImageUtils.java#L90" target="_blank" rel="noopener noreferrer"><code>TensorImageUtils.imageYUV420CenterCropToFloat32Tensor</code></a> method to convert <code>android.media.Image</code> in <code>YUV420</code> format to input tensor.</p><p>After getting predicted scores from the model it finds top K classes with the highest scores and shows on the UI.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="language-processing-example"></a>Language Processing Example<a class="hash-link" href="#language-processing-example" title="Direct link to heading">#</a></h4><p>Another example is natural language processing, based on an LSTM model, trained on a reddit comments dataset.
The logic happens in <a href="https://github.com/pytorch/android-demo-app/blob/master/PyTorchDemoApp/app/src/main/java/org/pytorch/demo/nlp/TextClassificationActivity.java" target="_blank" rel="noopener noreferrer"><code>TextClassificattionActivity</code></a>.</p><p>Result class names are packaged inside the TorchScript model and initialized just after initial module initialization.
The module has a <code>get_classes</code> method that returns <code>List[str]</code>, which can be called using method <code>Module.runMethod(methodName)</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    mModule = Module.load(moduleFileAbsoluteFilePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    IValue getClassesOutput = mModule.runMethod(&quot;get_classes&quot;);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The returned <code>IValue</code> can be converted to java array of <code>IValue</code> using <code>IValue.toList()</code> and processed to an array of strings using <code>IValue.toStr()</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    IValue[] classesListIValue = getClassesOutput.toList();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] moduleClasses = new String[classesListIValue.length];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    int i = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (IValue iv : classesListIValue) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      moduleClasses[i++] = iv.toStr();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Entered text is converted to java array of bytes with <code>UTF-8</code> encoding. <code>Tensor.fromBlobUnsigned</code> creates tensor of <code>dtype=uint8</code> from that array of bytes.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] bytes = text.getBytes(Charset.forName(&quot;UTF-8&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final long[] shape = new long[]{1, bytes.length};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Tensor inputTensor = Tensor.fromBlobUnsigned(bytes, shape);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Running inference of the model is similar to previous examples:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Tensor outputTensor = mModule.forward(IValue.from(inputTensor)).toTensor()</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After that, the code processes the output, finding classes with the highest scores.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="more-pytorch-android-demo-apps"></a>More PyTorch Android Demo Apps<a class="hash-link" href="#more-pytorch-android-demo-apps" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="d2go"></a>D2go<a class="hash-link" href="#d2go" title="Direct link to heading">#</a></h3><p><a href="https://github.com/pytorch/android-demo-app/tree/master/D2Go" target="_blank" rel="noopener noreferrer">D2Go</a> demonstrates a Python script that creates the much lighter and much faster Facebook <a href="https://github.com/facebookresearch/d2go" target="_blank" rel="noopener noreferrer">D2Go</a> model that is powered by PyTorch 1.8, torchvision 0.9, and Detectron2 with built-in SOTA networks for mobile, and an Android app that uses it to detect objects from pictures in your photos, taken with camera, or with live camera. This demo app also shows how to use the native pre-built torchvision-ops library.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="image-segmentation"></a>Image Segmentation<a class="hash-link" href="#image-segmentation" title="Direct link to heading">#</a></h3><p><a href="https://github.com/pytorch/android-demo-app/tree/master/ImageSegmentation" target="_blank" rel="noopener noreferrer">Image Segmentation</a> demonstrates a Python script that converts the PyTorch <a href="https://pytorch.org/hub/pytorch_vision_deeplabv3_resnet101/" target="_blank" rel="noopener noreferrer">DeepLabV3</a> model and an Android app that uses the model to segment images.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="object-detection"></a>Object Detection<a class="hash-link" href="#object-detection" title="Direct link to heading">#</a></h3><p><a href="https://github.com/pytorch/android-demo-app/tree/master/ObjectDetection" target="_blank" rel="noopener noreferrer">Object Detection</a> demonstrates how to convert the popular <a href="https://pytorch.org/hub/ultralytics_yolov5/" target="_blank" rel="noopener noreferrer">YOLOv5</a> model and use it in an Android app that detects objects from pictures in your photos, taken with camera, or with live camera.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="neural-machine-translation"></a>Neural Machine Translation<a class="hash-link" href="#neural-machine-translation" title="Direct link to heading">#</a></h3><p><a href="https://github.com/pytorch/android-demo-app/tree/master/Seq2SeqNMT" target="_blank" rel="noopener noreferrer">Neural Machine Translation</a> demonstrates how to convert a sequence-to-sequence neural machine translation model trained with the code in the <a href="https://pytorch.org/tutorials/intermediate/seq2seq_translation_tutorial.html" target="_blank" rel="noopener noreferrer">PyTorch NMT tutorial</a> and use the model in an Android app to do French-English translation.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="question-answering"></a>Question Answering<a class="hash-link" href="#question-answering" title="Direct link to heading">#</a></h3><p><a href="https://github.com/pytorch/android-demo-app/tree/master/QuestionAnswering" target="_blank" rel="noopener noreferrer">Question Answering</a> demonstrates how to convert a powerful transformer QA model and use the model in an Android app to answer questions about PyTorch Mobile and more.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="vision-transformer"></a>Vision Transformer<a class="hash-link" href="#vision-transformer" title="Direct link to heading">#</a></h3><p><a href="https://github.com/pytorch/android-demo-app/tree/master/ViT4MNIST" target="_blank" rel="noopener noreferrer">Vision Transformer</a> demonstrates how to use Facebook&#x27;s latest Vision Transformer <a href="https://github.com/facebookresearch/deit" target="_blank" rel="noopener noreferrer">DeiT</a> model to do image classification, and how convert another Vision Transformer model and use it in an Android app to perform handwritten digit recognition.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="speech-recognition"></a>Speech recognition<a class="hash-link" href="#speech-recognition" title="Direct link to heading">#</a></h3><p><a href="https://github.com/pytorch/android-demo-app/tree/master/SpeechRecognition" target="_blank" rel="noopener noreferrer">Speech Recognition</a> demonstrates how to convert Facebook AI&#x27;s wav2vec 2.0, one of the leading models in speech recognition, to TorchScript and how to use the scripted model in an Android app to perform speech recognition.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="video-classification"></a>Video Classification<a class="hash-link" href="#video-classification" title="Direct link to heading">#</a></h3><p><a href="https://github.com/pytorch/android-demo-app/tree/master/TorchVideo" target="_blank" rel="noopener noreferrer">TorchVideo</a> demonstrates how to use a pre-trained video classification model, available at the newly released <a href="https://github.com/facebookresearch/pytorchvideo" target="_blank" rel="noopener noreferrer">PyTorchVideo</a>, on Android to see video classification results, updated per second while the video plays, on tested videos, videos from the Photos library, or even real-time videos.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pytorch-android-tutorial-and-recipes"></a>PyTorch Android Tutorial and Recipes<a class="hash-link" href="#pytorch-android-tutorial-and-recipes" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="image-segmentation-deeplabv3-on-android"></a><a href="https://pytorch.org/tutorials/beginner/deeplabv3_on_android.html" target="_blank" rel="noopener noreferrer">Image Segmentation DeepLabV3 on Android</a><a class="hash-link" href="#image-segmentation-deeplabv3-on-android" title="Direct link to heading">#</a></h3><p>A comprehensive step-by-step tutorial on how to prepare and run the PyTorch DeepLabV3 image segmentation model on Android.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pytorch-mobile-performance-recipes"></a><a href="https://pytorch.org/tutorials/recipes/mobile_perf.html" target="_blank" rel="noopener noreferrer">PyTorch Mobile Performance Recipes</a><a class="hash-link" href="#pytorch-mobile-performance-recipes" title="Direct link to heading">#</a></h3><p>List of recipes for performance optimizations for using PyTorch on Mobile.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="making-android-native-application-that-uses-pytorch-android-prebuilt-libraries"></a><a href="https://pytorch.org/tutorials/recipes/android_native_app_with_custom_op.html" target="_blank" rel="noopener noreferrer">Making Android Native Application That Uses PyTorch Android Prebuilt Libraries</a><a class="hash-link" href="#making-android-native-application-that-uses-pytorch-android-prebuilt-libraries" title="Direct link to heading">#</a></h3><p>Learn how to make Android application from the scratch that uses LibTorch C++ API and uses TorchScript model with custom C++ operator.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="fuse-modules-recipe"></a><a href="https://pytorch.org/tutorials/recipes/fuse.html" target="_blank" rel="noopener noreferrer">Fuse Modules recipe</a><a class="hash-link" href="#fuse-modules-recipe" title="Direct link to heading">#</a></h3><p>Learn how to fuse a list of PyTorch modules into a single module to reduce the model size before quantization.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="quantization-for-mobile-recipe"></a><a href="https://pytorch.org/tutorials/recipes/quantization.html" target="_blank" rel="noopener noreferrer">Quantization for Mobile Recipe</a><a class="hash-link" href="#quantization-for-mobile-recipe" title="Direct link to heading">#</a></h3><p>Learn how to reduce the model size and make it run faster without losing much on accuracy.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="script-and-optimize-for-mobile"></a><a href="https://pytorch.org/tutorials/recipes/script_optimized.html" target="_blank" rel="noopener noreferrer">Script and Optimize for Mobile</a><a class="hash-link" href="#script-and-optimize-for-mobile" title="Direct link to heading">#</a></h3><p>Learn how to convert the model to TorchScipt and (optional) optimize it for mobile apps.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="model-preparation-for-android-recipe"></a><a href="https://pytorch.org/tutorials/recipes/model_preparation_android.html" target="_blank" rel="noopener noreferrer">Model Preparation for Android Recipe</a><a class="hash-link" href="#model-preparation-for-android-recipe" title="Direct link to heading">#</a></h3><p>Learn how to add the model in an Android project and use the PyTorch library for Android.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="using-the-pytorch-android-libraries-built-from-source-or-nightly"></a>Using the PyTorch Android Libraries Built from Source or Nightly<a class="hash-link" href="#using-the-pytorch-android-libraries-built-from-source-or-nightly" title="Direct link to heading">#</a></h2><p>First add the two aar files built above, or downloaded from the nightly built PyTorch Android repos at <a href="https://oss.sonatype.org/#nexus-search;quick~pytorch_android" target="_blank" rel="noopener noreferrer">here</a> and <a href="https://oss.sonatype.org/#nexus-search;quick~torchvision_android" target="_blank" rel="noopener noreferrer">here</a>, to the Android project&#x27;s <code>lib</code> folder, then add in the project&#x27;s app <code>build.gradle</code> file:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">allprojects {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    repositories {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        flatDir {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            dirs &#x27;libs&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dependencies {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // if using the libraries built from source</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation(name:&#x27;pytorch_android-release&#x27;, ext:&#x27;aar&#x27;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation(name:&#x27;pytorch_android_torchvision-release&#x27;, ext:&#x27;aar&#x27;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // if using the nightly built libraries downloaded above, for example the 1.8.0-snapshot on Jan. 21, 2021</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // implementation(name:&#x27;pytorch_android-1.8.0-20210121.092759-172&#x27;, ext:&#x27;aar&#x27;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // implementation(name:&#x27;pytorch_android_torchvision-1.8.0-20210121.092817-173&#x27;, ext:&#x27;aar&#x27;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation &#x27;com.android.support:appcompat-v7:28.0.0&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation &#x27;com.facebook.fbjni:fbjni-java-only:0.0.3&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Also we have to add all transitive dependencies of our aars. As <code>pytorch_android</code> depends on <code>com.android.support:appcompat-v7:28.0.0</code> or <code>androidx.appcompat:appcompat:1.2.0</code>, we need to one of them. (In case of using maven dependencies they are added automatically from <code>pom.xml</code>).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="using-the-nightly-pytorch-android-libraries"></a>Using the Nightly PyTorch Android Libraries<a class="hash-link" href="#using-the-nightly-pytorch-android-libraries" title="Direct link to heading">#</a></h2><p>Other than using the aar files built from source or downloaded from the links in the previous section, you can also use the nightly built Android PyTorch and TorchVision libraries by adding in your app <code>build.gradle</code> file the maven url and the nightly libraries implementation as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">repositories {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    maven {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        url &quot;https://oss.sonatype.org/content/repositories/snapshots&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dependencies {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation &#x27;org.pytorch:pytorch_android:1.8.0-SNAPSHOT&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation &#x27;org.pytorch:pytorch_android_torchvision:1.8.0-SNAPSHOT&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is the easiest way to try out the latest PyTorch code and the Android libraries, if you do not need to make any local changes. But be aware you may need to build the model used on mobile in the latest PyTorch - using either the latest PyTorch code or a quick nightly install with commands like <code>pip install --pre torch torchvision -f https://download.pytorch.org/whl/nightly/cpu/torch_nightly.html</code> - to avoid possible model version mismatch errors when running the model on mobile.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="custom-build"></a>Custom Build<a class="hash-link" href="#custom-build" title="Direct link to heading">#</a></h2><p>To reduce the size of binaries you can do custom build of PyTorch Android with only set of operators required by your model.
This includes two steps: preparing the list of operators from your model, rebuilding pytorch android with specified list.</p><p>1. Verify your PyTorch version is 1.4.0 or above. You can do that by checking the value of <code>torch.__version__</code>.</p><p>2. Preparation of the list of operators</p><p>List of operators of your serialized torchscript model can be prepared in yaml format using python api function <code>torch.jit.export_opnames()</code>.
To dump the operators in your model, say <code>MobileNetV2</code>, run the following lines of Python code:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># Dump list of operators used by MobileNetV2:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import torch, yaml</span></span><span class="token-line" style="color:#393A34"><span class="token plain">model = torch.jit.load(&#x27;MobileNetV2.pt&#x27;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ops = torch.jit.export_opnames(model)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">with open(&#x27;MobileNetV2.yaml&#x27;, &#x27;w&#x27;) as output:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    yaml.dump(ops, output)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>3. Building PyTorch Android with prepared operators list.</p><p>To build PyTorch Android with the prepared yaml list of operators, specify it in the environment variable <code>SELECTED_OP_LIST</code>. Also in the arguments, specify which Android ABIs it should build; by default it builds all 4 Android ABIs.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># Build PyTorch Android library customized for MobileNetV2:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECTED_OP_LIST=MobileNetV2.yaml scripts/build_pytorch_android.sh arm64-v8a</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After successful build you can integrate the result aar files to your android gradle project, following the steps from previous section of this tutorial (Building PyTorch Android from Source).</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="use-pytorch-jit-interpreter"></a>Use PyTorch JIT interpreter<a class="hash-link" href="#use-pytorch-jit-interpreter" title="Direct link to heading">#</a></h2><p>PyTorch JIT interpreter is the default interpreter before 1.9 (a version of our PyTorch interpreter that is not as size-efficient). It will still be supported in 1.9, and can be used via <code>build.gradle</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">repositories {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    jcenter()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dependencies {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation &#x27;org.pytorch:pytorch_android:1.9.0&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation &#x27;org.pytorch:pytorch_android_torchvision:1.9.0&#x27;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="android-tutorials"></a>Android Tutorials<a class="hash-link" href="#android-tutorials" title="Direct link to heading">#</a></h2><p>Watch the following <a href="https://youtu.be/5Lxuu16_28o" target="_blank" rel="noopener noreferrer">video</a> as PyTorch Partner Engineer Brad Heintz walks through steps for setting up the PyTorch Runtime for Android projects:</p><p><a href="https://youtu.be/5Lxuu16_28o" target="_blank" rel="noopener noreferrer" title="PyTorch Mobile Runtime for Android"><img src="https://i.ytimg.com/vi/O_2KBhkIvnc/maxresdefault.jpg" alt="PyTorch Mobile Runtime for Android">{:height=&quot;75%&quot; width=&quot;75%&quot;}</a></p><p>The corresponding code can be found <a href="https://github.com/pytorch/workshops/tree/master/PTMobileWalkthruAndroid" target="_blank" rel="noopener noreferrer">here</a>.</p><p>Checkout our <a href="https://pytorch.org/tutorials/recipes/mobile_perf.html" target="_blank" rel="noopener noreferrer">Mobile Performance Recipes</a> which cover how to optimize your model and check if optimizations helped via benchmarking.</p><p>In addition, follow this recipe to learn how to <a href="https://pytorch.org/tutorials/recipes/android_native_app_with_custom_op.html" target="_blank" rel="noopener noreferrer">make Native Android Application that use PyTorch prebuilt libraries</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="api-docs"></a>API Docs<a class="hash-link" href="#api-docs" title="Direct link to heading">#</a></h2><p>You can find more details about the PyTorch Android API in the <a href="https://pytorch.org/javadoc/" target="_blank" rel="noopener noreferrer">Javadoc</a>.</p><script page-id="android" src="{{ site.baseurl }}/assets/menu-tab-selection.js"></script></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/android.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/mobile-ds/docs/videos/overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Getting Started</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/mobile-ds/docs/ios"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">iOS »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#quickstart-with-a-helloworld-example" class="table-of-contents__link">Quickstart with a HelloWorld Example</a></li><li><a href="#pytorch-demo-application" class="table-of-contents__link">PyTorch Demo Application</a></li><li><a href="#more-pytorch-android-demo-apps" class="table-of-contents__link">More PyTorch Android Demo Apps</a><ul><li><a href="#d2go" class="table-of-contents__link">D2go</a></li><li><a href="#image-segmentation" class="table-of-contents__link">Image Segmentation</a></li><li><a href="#object-detection" class="table-of-contents__link">Object Detection</a></li><li><a href="#neural-machine-translation" class="table-of-contents__link">Neural Machine Translation</a></li><li><a href="#question-answering" class="table-of-contents__link">Question Answering</a></li><li><a href="#vision-transformer" class="table-of-contents__link">Vision Transformer</a></li><li><a href="#speech-recognition" class="table-of-contents__link">Speech recognition</a></li><li><a href="#video-classification" class="table-of-contents__link">Video Classification</a></li></ul></li><li><a href="#pytorch-android-tutorial-and-recipes" class="table-of-contents__link">PyTorch Android Tutorial and Recipes</a><ul><li><a href="#image-segmentation-deeplabv3-on-android" class="table-of-contents__link">Image Segmentation DeepLabV3 on Android</a></li><li><a href="#pytorch-mobile-performance-recipes" class="table-of-contents__link">PyTorch Mobile Performance Recipes</a></li><li><a href="#making-android-native-application-that-uses-pytorch-android-prebuilt-libraries" class="table-of-contents__link">Making Android Native Application That Uses PyTorch Android Prebuilt Libraries</a></li><li><a href="#fuse-modules-recipe" class="table-of-contents__link">Fuse Modules recipe</a></li><li><a href="#quantization-for-mobile-recipe" class="table-of-contents__link">Quantization for Mobile Recipe</a></li><li><a href="#script-and-optimize-for-mobile" class="table-of-contents__link">Script and Optimize for Mobile</a></li><li><a href="#model-preparation-for-android-recipe" class="table-of-contents__link">Model Preparation for Android Recipe</a></li></ul></li><li><a href="#using-the-pytorch-android-libraries-built-from-source-or-nightly" class="table-of-contents__link">Using the PyTorch Android Libraries Built from Source or Nightly</a></li><li><a href="#using-the-nightly-pytorch-android-libraries" class="table-of-contents__link">Using the Nightly PyTorch Android Libraries</a></li><li><a href="#custom-build" class="table-of-contents__link">Custom Build</a></li><li><a href="#use-pytorch-jit-interpreter" class="table-of-contents__link">Use PyTorch JIT interpreter</a></li><li><a href="#android-tutorials" class="table-of-contents__link">Android Tutorials</a></li><li><a href="#api-docs" class="table-of-contents__link">API Docs</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mobile-ds/docs/intro">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/pytorch/pytorch" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/mobile-ds/assets/js/runtime~main.13c9f74d.js"></script>
<script src="/mobile-ds/assets/js/main.fec1926f.js"></script>
</body>
</html>
<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.1">
<link rel="alternate" type="application/rss+xml" href="/mobile-ds/blog/rss.xml" title="PyTorch Mobile Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/mobile-ds/blog/atom.xml" title="PyTorch Mobile Blog Atom Feed"><title data-react-helmet="true">Script and Optimize for Mobile | PyTorch Mobile</title><meta data-react-helmet="true" property="og:url" content="https://brianjo.github.com/mobile-ds/docs/modelprep/optimization"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Script and Optimize for Mobile | PyTorch Mobile"><meta data-react-helmet="true" name="description" content="This recipe demonstrates how to convert a PyTorch model to TorchScript"><meta data-react-helmet="true" property="og:description" content="This recipe demonstrates how to convert a PyTorch model to TorchScript"><link data-react-helmet="true" rel="shortcut icon" href="/mobile-ds/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://brianjo.github.com/mobile-ds/docs/modelprep/optimization"><link data-react-helmet="true" rel="alternate" href="https://brianjo.github.com/mobile-ds/docs/modelprep/optimization" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://brianjo.github.com/mobile-ds/docs/modelprep/optimization" hreflang="x-default"><link rel="stylesheet" href="/mobile-ds/assets/css/styles.f84ef0c2.css">
<link rel="preload" href="/mobile-ds/assets/js/runtime~main.e05b8f85.js" as="script">
<link rel="preload" href="/mobile-ds/assets/js/main.b7e865d3.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP shadow--md">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/mobile-ds/"><img src="/mobile-ds/img/logo.svg" alt="PyTorch" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/mobile-ds/img/logo.svg" alt="PyTorch" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">PyTorch Mobile</b></a><a class="navbar__item navbar__link navbar__link--active" href="/mobile-ds/docs/intro">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/pytorch/pytorch" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/mobile-ds/"><img src="/mobile-ds/img/logo.svg" alt="PyTorch" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/mobile-ds/img/logo.svg" alt="PyTorch" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">PyTorch Mobile</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/mobile-ds/docs/intro">Documentation</a></li><li class="menu__list-item"><a href="https://github.com/pytorch/pytorch" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu menu--responsive thin-scrollbar menu_Bmed" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/mobile-ds/docs/intro">PyTorch Mobile</a></li><li class="menu__list-item"><a class="menu__link" href="/mobile-ds/docs/helloworld">Hello World!</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Model Preparation</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-ds/docs/modelprep/interpreters">Lite and Full Jit Interpreters</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/mobile-ds/docs/modelprep/optimization">Script and Optimize for Mobile</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/mobile-ds/docs/modelprep/quantization">Quantization</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Build from Source</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/building/androidbuild">Building PyTorch Android from Source</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/mobile-ds/docs/building/iosbuild">Build PyTorch iOS Libraries from Source</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/mobile-ds/docs/android">Android</a></li><li class="menu__list-item"><a class="menu__link" href="/mobile-ds/docs/ios">iOS</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><header><h1 class="h1Heading_27L5">Script and Optimize for Mobile</h1></header><p>This recipe demonstrates how to convert a PyTorch model to TorchScript
which can run in a high-performance C++ environment such as iOS and
Android, and how to optimize the converted TorchScript model for mobile
deployment.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h2><p>After a PyTorch model is trained and optionally but preferably quantized
(see <a href="/mobile-ds/docs/modelprep/quantization.html">Quantization Recipe</a> for more details), one
essential step before the model can be used in iOS and Android apps is
to convert the Python-dependent model to TorchScript, which can then
further be optimized for mobile apps. Conversion to TorchScript can be
as simple as a single call, or as complicated as changing the original
model in many different places.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pre-requisites"></a>Pre-requisites<a class="hash-link" href="#pre-requisites" title="Direct link to heading">#</a></h2><p>PyTorch 1.6.0 or 1.7.0</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="conversion-to-torchscript"></a>Conversion to TorchScript<a class="hash-link" href="#conversion-to-torchscript" title="Direct link to heading">#</a></h2><p>There are two basic ways to convert a PyTorch model to TorchScript,
using <span class="title-ref">trace</span> and <span class="title-ref">script</span>. Mixing <span class="title-ref">trace</span> and <span class="title-ref">script</span>
may also be needed in some cases - see
<a href="https://pytorch.org/tutorials/beginner/Intro_to_TorchScript_tutorial.html#mixing-scripting-and-tracing" target="_blank" rel="noopener noreferrer">here</a>
for more information.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="use-the-trace-method"></a>Use the <span class="title-ref">trace</span> Method<a class="hash-link" href="#use-the-trace-method" title="Direct link to heading">#</a></h3><p>To use the <span class="title-ref">trace</span> method on a model, an
example or dummy input for the model needs to be specified, the actual
input size needs to be the same as the example input size, and the model
definition cannot have control flow such as <span class="title-ref">if</span> or <span class="title-ref">for</span>. The
reason for these constraints is that running <span class="title-ref">trace</span> on a model with an example input simply
calls the model&#x27;s <span class="title-ref">forward</span> method with the
input and all operations executed in the model layers are recorded,
creating the trace of the model.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">import torch</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">dummy_input = torch.rand(1, 3, 224, 224)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">torchscript_model = torch.jit.trace(model_quantized, dummy_input)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="use-the-script-method"></a>Use the <span class="title-ref">script</span> Method<a class="hash-link" href="#use-the-script-method" title="Direct link to heading">#</a></h3><p>For the example above, calling <span class="title-ref">script</span>
below makes no difference:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">torchscript_model = torch.jit.script(model_quantized)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>But if a model has some flow control, then <span class="title-ref">trace</span> won&#x27;t correctly record all the possible
traces. Take some code snippet of an example model definition from
<a href="https://pytorch.org/tutorials/beginner/Intro_to_TorchScript_tutorial.html" target="_blank" rel="noopener noreferrer">here</a>
for example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">import torch</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">class MyDecisionGate(torch.nn.Module):</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    def forward(self, x):</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if x.sum() &gt; 0:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return x</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        else:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return -x</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">x = torch.rand(3, 4)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">traced_cell = torch.jit.trace(MyDecisionGate(), x)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">print(traced_cell.code)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The code above will output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">TracerWarning: Converting a tensor to a Python boolean might cause the trace </span></span><span class="token-line" style="color:#393A34"><span class="token plain">to be incorrect. We can&#x27;&#x27;t record the data flow of Python values, so this value </span></span><span class="token-line" style="color:#393A34"><span class="token plain">will be treated as a constant in the future. This means that the trace might </span></span><span class="token-line" style="color:#393A34"><span class="token plain">not generalize to other inputs!</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if x.sum() &gt; 0:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">def forward(self,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  x: Tensor) -&gt; Tensor:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">return x</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Note that &quot;the trace might not generalize to other inputs&quot; warning above
means that if the model has any kind of data-dependent control flow,</p><span class="title-ref">trace</span> is not the right answer. But if we replace the last two lines of the Python code snippet above (before the code output) with:<div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">scripted_cell = torch.jit.script(MyDecisionGate())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">print(scripted_cell.code)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The scripted model as shown by the <span class="title-ref">print</span>
result below will be covering all possible inputs, thus generalizing to
other inputs:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">def forward(self,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    x: Tensor) -&gt; Tensor:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  _0 = bool(torch.gt(torch.sum(x, dtype=None), 0))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if _0:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    _1 = x</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  else:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    _1 = torch.neg(x)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  return _1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is another example of using <span class="title-ref">trace</span>
and <span class="title-ref">script</span> - it converts the model
trained in the PyTorch tutorial <a href="https://pytorch.org/tutorials/intermediate/seq2seq_translation_tutorial.html" target="_blank" rel="noopener noreferrer">NLP FROM SCRATCH: TRANSLATION WITH A
SEQUENCE TO SEQUENCE NETWORK AND
ATTENTION</a>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">encoder = EncoderRNN(input_lang.n_words, hidden_size)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">decoder = AttnDecoderRNN(hidden_size, output_lang.n_words)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># method 1: using trace with example inputs</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">encoder_input=torch.tensor([1])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">encoder_hidden=torch.zeros(1, 1, hidden_size)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">decoder_input1=torch.tensor([[0]])</span></span><span class="token-line" style="color:#393A34"><span class="token plain">decoder_input2=torch.zeros(1, 1, hidden_size)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">decoder_input3=torch.zeros(MAX_LENGTH, hidden_size)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">traced_encoder = torch.jit.trace(encoder, (encoder_input, encoder_hidden))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">traced_decoder = torch.jit.trace(decoder, (decoder_input1, decoder_input2, decoder_input3))</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># method 2: using script</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">scripted_encoder = torch.jit.script(encoder)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">scripted_decoder = torch.jit.script(decoder)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>So is it true that one can simply always use the <span class="title-ref">script</span> call and the model is converted to
TorchScript? The answer is no, because TorchScript is actually a subset
of Python and to make <span class="title-ref">script</span> work, the
PyTorch model definition must only use the language features of that
TorchScript subset of Python. <a href="https://pytorch.org/docs/master/jit_language_reference.html#language-reference" target="_blank" rel="noopener noreferrer">TorchScript Language
Reference</a>
covers all the details of what is supported in TorchScript. Below we
will describe some of the common errors when using the <span class="title-ref">script</span> method.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="fix-common-errors-when-using-the-script-method"></a>Fix Common Errors When Using the <span class="title-ref">script</span> Method<a class="hash-link" href="#fix-common-errors-when-using-the-script-method" title="Direct link to heading">#</a></h2><p>If you apply the <span class="title-ref">script</span> method to a
non-trivial model, chances are you may encounter several types of
errors. Check out <a href="https://pytorch.org/tutorials/beginner/deploy_seq2seq_hybrid_frontend_tutorial.html" target="_blank" rel="noopener noreferrer">this
tutorial</a>
for a complete example of converting a chatbot model to TorchScript. But
follow the steps below to fix common errors when you run the <span class="title-ref">script</span> method:</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-runtimeerror-attribute-lookup-is-not-defined-on-python-value-of-type"></a>1. RuntimeError <span class="title-ref">attribute lookup is not defined on python value of type</span><a class="hash-link" href="#1-runtimeerror-attribute-lookup-is-not-defined-on-python-value-of-type" title="Direct link to heading">#</a></h3><p>For this error, pass the value of the model as a parameter in the
constructor. This is because when calling <span class="title-ref">script</span> on a model that accepts another model as
a parameter, the model passed is actually of type <span class="title-ref">TracedModule</span> or <span class="title-ref">ScriptModule</span>, not of type <span class="title-ref">Module</span>, making the the model attribute not
defined when scripting.</p><p>For example, the <span class="title-ref">LuongAttnDecoderRNN</span>
module in the tutorial above has an attribute <span class="title-ref">n_layers</span>, and the <span class="title-ref">GreedySearchDecoder</span> module refers to the <span class="title-ref">n_layers</span> attribute of a <span class="title-ref">decoder</span> instance of the <span class="title-ref">LuongAttnDecoderRNN</span> module, so in order to make</p><span class="title-ref">script</span> work, the <span class="title-ref">GreedySearchDecoder</span> module&#x27;s constructor needs to be changed from:<div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">def __init__(self, encoder, decoder):</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>to:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">def __init__(self, encoder, decoder, decoder_n_layers):</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  self._decoder_n_layers = decoder_n_layers</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>and the <span class="title-ref">GreedySearchDecoder</span>&#x27;s <span class="title-ref">forward</span> method needs to refer <span class="title-ref">self._decoder_n_layers</span> instead of <span class="title-ref">decoder.n_layers</span>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-runtimeerror-python-value-of-type--cannot-be-used-as-a-value"></a>2. RuntimeError <span class="title-ref">python value of type &#x27;...&#x27; cannot be used as a value.</span><a class="hash-link" href="#2-runtimeerror-python-value-of-type--cannot-be-used-as-a-value" title="Direct link to heading">#</a></h3><p>The complete error message for this one continues with <span class="title-ref">Perhaps it is a closed over global variable? If so,
please consider passing it in as an argument or use a local variable
instead.</span>, store global variables&#x27; values as attributes in the
model constructor (there&#x27;s no need to add them to a special list called</p><span class="title-ref">\_\_constants\_\_</span>). The reason is that global values can be used conveniently in normal model training and inference, but the global values are not accessible during the scripting.<p>For example, <span class="title-ref">device</span> and <span class="title-ref">SOS_token</span> are global variables, and to make</p><span class="title-ref">script</span> work, they need to be added to the<span class="title-ref">GreedySearchDecoder</span>&#x27;s constructor:<div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">self._device = device</span></span><span class="token-line" style="color:#393A34"><span class="token plain">self._SOS_token = SOS_token</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>and referred to as <span class="title-ref">self._device</span> and</p><span class="title-ref">self.\_SOS\_token</span> instead of <span class="title-ref">device</span> and <span class="title-ref">SOS\_token</span> in the <span class="title-ref">GreedySearchDecoder</span>&#x27;s <span class="title-ref">forward</span> method.<h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-runtimeerror-all-inputs-of-range-must-be--found-tensor-inferred-in-argument"></a>3. RuntimeError <span class="title-ref">all inputs of range must be &#x27;...&#x27;, found Tensor (inferred) in argument</span><a class="hash-link" href="#3-runtimeerror-all-inputs-of-range-must-be--found-tensor-inferred-in-argument" title="Direct link to heading">#</a></h3><p>The error message continues with: <span class="title-ref">add type
definitions for each of the module&#x27;s forward method arguments. Because
all parameters to a TorchScript function are of the
`torch.Tensor</span> type by default, you need to specifically declare
the type for each parameter that is not of type &#x27;Tensor&#x27;. For a complete
list of TorchScript-supported types, see
<a href="https://pytorch.org/docs/master/jit_language_reference.html#supported-type" target="_blank" rel="noopener noreferrer">here</a>.</p><p>For example, the <span class="title-ref">GreedySearchDecoder</span>&#x27;s</p><span class="title-ref">forward</span> method signature needs to be changed from:<div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">def forward(self, input_seq, input_length, max_length):</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>to:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">def forward(self, input_seq, input_length, max_length : int):</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After using the <span class="title-ref">trace</span> or <span class="title-ref">script</span> method above, and fixing possible
errors, you should have a TorchScript model ready to be optimized for
mobile.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="optimize-a-torchscript-model"></a>Optimize a TorchScript Model<a class="hash-link" href="#optimize-a-torchscript-model" title="Direct link to heading">#</a></h2><p>Simply run the following code snippet to optimize a TorchScript model
generated with the <span class="title-ref">trace</span> and/or <span class="title-ref">script</span> method:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">from torch.utils.mobile_optimizer import optimize_for_mobile</span></span><span class="token-line" style="color:#393A34"><span class="token plain">optimized_torchscript_model = optimize_for_mobile(torchscript_model)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The optimized model can then be saved and deployed in mobile apps:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">optimized_torchscript_model.save(&quot;optimized_torchscript_model.pth&quot;)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>By default, <span class="title-ref">optimize_for_mobile</span> will
perform the following types of optimizations:</p><ul><li>Conv2D and BatchNorm fusion which folds Conv2d-BatchNorm2d into
Conv2d;</li><li>Insert and fold prepacked ops which rewrites the model graph to
replace 2D convolutions and linear ops with their prepacked
counterparts.</li><li>ReLU and hardtanh fusion which rewrites graph by finding
ReLU/hardtanh ops and fuses them together.</li><li>Dropout removal which removes dropout nodes from this module when
training is false.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="learn-more"></a>Learn More<a class="hash-link" href="#learn-more" title="Direct link to heading">#</a></h2><ol><li>The official <a href="https://pytorch.org/docs/stable/jit_language_reference.html" target="_blank" rel="noopener noreferrer">TorchScript Language
Reference</a>.</li><li>The <span class="title-ref">torch.utils.mobile_optimizer</span><a href="https://pytorch.org/docs/stable/mobile_optimizer.html" target="_blank" rel="noopener noreferrer">API
documentation</a>.</li></ol></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/modelprep/optimization.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/mobile-ds/docs/modelprep/interpreters"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Lite and Full Jit Interpreters</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/mobile-ds/docs/modelprep/quantization"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Quantization »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link">Introduction</a></li><li><a href="#pre-requisites" class="table-of-contents__link">Pre-requisites</a></li><li><a href="#conversion-to-torchscript" class="table-of-contents__link">Conversion to TorchScript</a><ul><li><a href="#use-the-trace-method" class="table-of-contents__link">Use the <span class="title-ref">trace</span> Method</a></li><li><a href="#use-the-script-method" class="table-of-contents__link">Use the <span class="title-ref">script</span> Method</a></li></ul></li><li><a href="#fix-common-errors-when-using-the-script-method" class="table-of-contents__link">Fix Common Errors When Using the <span class="title-ref">script</span> Method</a><ul><li><a href="#1-runtimeerror-attribute-lookup-is-not-defined-on-python-value-of-type" class="table-of-contents__link">1. RuntimeError <span class="title-ref">attribute lookup is not defined on python value of type</span></a></li><li><a href="#2-runtimeerror-python-value-of-type--cannot-be-used-as-a-value" class="table-of-contents__link">2. RuntimeError <span class="title-ref">python value of type &#39;...&#39; cannot be used as a value.</span></a></li><li><a href="#3-runtimeerror-all-inputs-of-range-must-be--found-tensor-inferred-in-argument" class="table-of-contents__link">3. RuntimeError <span class="title-ref">all inputs of range must be &#39;...&#39;, found Tensor (inferred) in argument</span></a></li></ul></li><li><a href="#optimize-a-torchscript-model" class="table-of-contents__link">Optimize a TorchScript Model</a></li><li><a href="#learn-more" class="table-of-contents__link">Learn More</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/mobile-ds/docs/intro">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/pytorch/pytorch" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/mobile-ds/assets/js/runtime~main.e05b8f85.js"></script>
<script src="/mobile-ds/assets/js/main.b7e865d3.js"></script>
</body>
</html>